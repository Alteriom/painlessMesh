name: PlatformIO Library Publishing

on:
  # Trigger on new releases (tags)
  release:
    types: [published]
  
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.6.1)'
        required: true
        type: string
      force_publish:
        description: 'Force publish even if version exists'
        required: false
        type: boolean
        default: false

# Prevent concurrent publications
concurrency:
  group: "platformio-publish"
  cancel-in-progress: false

permissions:
  contents: read
  actions: read

jobs:
  validate-library:
    name: Validate PlatformIO Library Configuration
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is-valid: ${{ steps.validation.outputs.is-valid }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python and PlatformIO
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install PlatformIO Core
        run: |
          pip install --upgrade platformio
          pio --version

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            echo "Manual trigger - using version: $VERSION"
          else
            # Extract from tag or library.properties
            if [ -n "${{ github.event.release.tag_name }}" ]; then
              VERSION="${{ github.event.release.tag_name }}"
              VERSION="${VERSION#v}"  # Remove 'v' prefix if present
            else
              VERSION=$(grep '^version=' library.properties | cut -d'=' -f2)
            fi
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

      - name: Validate library.json format
        id: validation
        run: |
          echo "üîç Validating library.json format..."
          
          # Check if library.json exists
          if [ ! -f "library.json" ]; then
            echo "‚ùå library.json not found!"
            exit 1
          fi
          
          # Validate JSON syntax
          if ! jq . library.json > /dev/null; then
            echo "‚ùå library.json is not valid JSON!"
            exit 1
          fi
          
          # Check required fields
          REQUIRED_FIELDS="name description version frameworks platforms authors"
          for field in $REQUIRED_FIELDS; do
            if ! jq -e ".$field" library.json > /dev/null; then
              echo "‚ùå Missing required field: $field"
              exit 1
            fi
          done
          
          # Validate version consistency
          JSON_VERSION=$(jq -r '.version' library.json)
          PROP_VERSION=$(grep '^version=' library.properties | cut -d'=' -f2)
          
          if [ "$JSON_VERSION" != "$PROP_VERSION" ]; then
            echo "‚ùå Version mismatch:"
            echo "  library.json: $JSON_VERSION"
            echo "  library.properties: $PROP_VERSION"
            exit 1
          fi
          
          # Validate dependencies exist in PlatformIO Registry
          echo "üîç Validating dependencies..."
          jq -r '.dependencies[]? | "\(.owner)/\(.name)@\(.version)"' library.json | while read dep; do
            if [ -n "$dep" ]; then
              OWNER=$(echo "$dep" | cut -d'/' -f1)
              PKG_NAME=$(echo "$dep" | cut -d'/' -f2 | cut -d'@' -f1)
              echo "  Checking: $OWNER/$PKG_NAME"
              
              if ! pio pkg search "$PKG_NAME" | grep -q "$OWNER/$PKG_NAME"; then
                echo "‚ö†Ô∏è  Warning: Dependency $OWNER/$PKG_NAME not found in PlatformIO Registry"
              else
                echo "  ‚úÖ Found: $OWNER/$PKG_NAME"
              fi
            fi
          done
          
          # Check if examples exist and are valid
          if jq -e '.examples' library.json > /dev/null; then
            echo "üîç Validating examples..."
            jq -r '.examples[]?' library.json | while read example; do
              if [ -n "$example" ] && [ ! -f "$example" ]; then
                echo "‚ö†Ô∏è  Warning: Example file not found: $example"
              else
                echo "  ‚úÖ Found example: $example"
              fi
            done
          fi
          
          echo "‚úÖ library.json validation passed!"
          echo "is-valid=true" >> $GITHUB_OUTPUT

      - name: Check existing library in registry
        run: |
          echo "üîç Checking if library exists in PlatformIO Registry..."
          
          LIBRARY_NAME=$(jq -r '.name' library.json)
          VERSION="${{ steps.version.outputs.version }}"
          
          # Search for the library
          if pio pkg search "$LIBRARY_NAME" | grep -q "$LIBRARY_NAME"; then
            echo "üì¶ Library '$LIBRARY_NAME' found in PlatformIO Registry"
            
            # Try to get version info (this might fail for new libraries)
            if pio pkg show "$LIBRARY_NAME" 2>/dev/null | grep -q "Version: $VERSION"; then
              echo "‚ö†Ô∏è  Version $VERSION already exists in registry"
              if [ "${{ github.event.inputs.force_publish }}" != "true" ]; then
                echo "‚ùå Version $VERSION already published. Use force_publish to override."
                exit 1
              else
                echo "üîÑ Force publish enabled - will attempt to update"
              fi
            else
              echo "‚úÖ Version $VERSION not found - ready for publishing"
            fi
          else
            echo "üÜï Library '$LIBRARY_NAME' not found in registry - this will be a new publication"
          fi

      - name: Test library installation
        run: |
          echo "üß™ Testing library installation in a clean environment..."
          
          # Create temporary test project
          mkdir -p test_install
          cd test_install
          
          # Initialize a test project
          pio project init --board esp32dev --project-option "framework = arduino"
          
          # Test dependency installation
          echo "üì¶ Testing dependency installation..."
          jq -r '.dependencies[]? | "\(.owner)/\(.name)@\(.version // "*")"' ../library.json | while read dep; do
            if [ -n "$dep" ]; then
              echo "  Installing: $dep"
              if pio pkg install --library "$dep"; then
                echo "  ‚úÖ Successfully installed: $dep"
              else
                echo "  ‚ùå Failed to install: $dep"
                exit 1
              fi
            fi
          done
          
          echo "‚úÖ All dependencies installed successfully!"
          
          cd ..
          rm -rf test_install

  publish-to-platformio:
    name: Publish to PlatformIO Library Registry
    needs: validate-library
    runs-on: ubuntu-latest
    if: needs.validate-library.outputs.is-valid == 'true'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python and PlatformIO
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install PlatformIO Core
        run: |
          pip install --upgrade platformio
          pio --version

      - name: Configure PlatformIO Authentication
        run: |
          echo "üîë Configuring PlatformIO authentication..."
          
          if [ -z "${{ secrets.PLATFORMIO_AUTH_TOKEN }}" ]; then
            echo "‚ùå PLATFORMIO_AUTH_TOKEN secret is not configured!"
            echo ""
            echo "üìã To set up PlatformIO authentication:"
            echo "1. Go to https://platformio.org/account/token"
            echo "2. Generate a Personal Access Token"
            echo "3. Add it as PLATFORMIO_AUTH_TOKEN in repository secrets:"
            echo "   Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret"
            echo "4. Name: PLATFORMIO_AUTH_TOKEN"
            echo "5. Value: [your token]"
            echo ""
            echo "‚ö†Ô∏è  Skipping PlatformIO publication due to missing authentication"
            exit 1
          fi
          
          # Set the auth token via environment variable
          echo "PLATFORMIO_AUTH_TOKEN=${{ secrets.PLATFORMIO_AUTH_TOKEN }}" >> $GITHUB_ENV
          
          # Verify authentication
          if pio account show; then
            echo "‚úÖ PlatformIO authentication successful"
          else
            echo "‚ùå PlatformIO authentication failed"
            exit 1
          fi
        env:
          PLATFORMIO_AUTH_TOKEN: ${{ secrets.PLATFORMIO_AUTH_TOKEN }}

      - name: Prepare library for publication
        run: |
          echo "üì¶ Preparing library for PlatformIO publication..."
          
          VERSION="${{ needs.validate-library.outputs.version }}"
          LIBRARY_NAME=$(jq -r '.name' library.json)
          
          echo "Library: $LIBRARY_NAME"
          echo "Version: $VERSION"
          
          # Validate the library structure
          echo "üîç Validating library structure..."
          
          # Check for required files
          REQUIRED_FILES="library.json src/"
          for file in $REQUIRED_FILES; do
            if [ ! -e "$file" ]; then
              echo "‚ùå Required file/directory missing: $file"
              exit 1
            fi
          done
          
          # Ensure version matches
          if [ "$(jq -r '.version' library.json)" != "$VERSION" ]; then
            echo "üîÑ Updating library.json version to $VERSION"
            jq ".version = \"$VERSION\"" library.json > library.json.tmp
            mv library.json.tmp library.json
          fi
          
          echo "‚úÖ Library structure validation passed"

      - name: Publish to PlatformIO Registry
        run: |
          echo "üöÄ Publishing to PlatformIO Library Registry..."
          
          VERSION="${{ needs.validate-library.outputs.version }}"
          LIBRARY_NAME=$(jq -r '.name' library.json)
          
          echo "================================"
          echo "üì¶ Publishing Library"
          echo "================================"
          echo "Name: $LIBRARY_NAME"
          echo "Version: $VERSION"
          echo "Repository: ${{ github.repository }}"
          echo "Tag: ${{ github.event.release.tag_name || github.ref }}"
          echo ""
          
          # Attempt to publish the library with non-interactive mode
          if pio pkg publish . --no-interactive; then
            echo "‚úÖ Successfully published to PlatformIO Library Registry!"
            
            # Wait a moment for registry to update
            sleep 10
            
            # Verify publication
            echo "üîç Verifying publication..."
            if pio pkg search "$LIBRARY_NAME" | grep -q "$LIBRARY_NAME"; then
              echo "‚úÖ Library verified in registry"
              
              # Try to get detailed info
              if pio pkg show "$LIBRARY_NAME" 2>/dev/null; then
                echo "üìã Library details retrieved successfully"
              fi
            else
              echo "‚ö†Ô∏è  Library not immediately visible in search (may take a few minutes)"
            fi
            
          else
            echo "‚ùå Failed to publish to PlatformIO Library Registry"
            echo ""
            echo "üîç Possible reasons:"
            echo "1. Library name already exists with this version"
            echo "2. Authentication token expired or invalid"
            echo "3. Library validation failed on PlatformIO side"
            echo "4. Network or service issues"
            echo "5. Interactive confirmation was not handled properly"
            echo ""
            echo "üìã Manual alternatives:"
            echo "1. Check library at: https://registry.platformio.org/libraries"
            echo "2. Submit manually at: https://registry.platformio.org/libraries/new"
            echo "3. Use: pio pkg publish --help for more options"
            echo "4. Try: pio pkg publish . --no-interactive"
            
            exit 1
          fi

      - name: Publication Success Summary
        run: |
          VERSION="${{ needs.validate-library.outputs.version }}"
          LIBRARY_NAME=$(jq -r '.name' library.json)
          
          echo "================================"
          echo "üéâ PlatformIO Publication Successful!"
          echo "================================"
          echo ""
          echo "üì¶ Library: $LIBRARY_NAME"
          echo "üè∑Ô∏è  Version: $VERSION"
          echo "üîó Registry: https://registry.platformio.org/libraries"
          echo "üìã Search: https://registry.platformio.org/search?q=$LIBRARY_NAME"
          echo ""
          echo "üì• Installation Instructions:"
          echo ""
          echo "PlatformIO (platformio.ini):"
          echo "lib_deps = $LIBRARY_NAME@^$VERSION"
          echo ""
          echo "PlatformIO CLI:"
          echo "pio pkg install --library \"$LIBRARY_NAME@^$VERSION\""
          echo ""
          echo "üìö Additional Resources:"
          echo "‚Ä¢ Documentation: https://github.com/${{ github.repository }}/wiki"
          echo "‚Ä¢ Examples: https://github.com/${{ github.repository }}/tree/main/examples"
          echo "‚Ä¢ Issues: https://github.com/${{ github.repository }}/issues"
          echo ""
          echo "üîÑ It may take 5-15 minutes for the library to appear in searches"
          echo "================================"

  notify-completion:
    name: Notify Publication Completion
    needs: [validate-library, publish-to-platformio]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Publication Status Summary
        run: |
          echo "================================"
          echo "üìä PlatformIO Publication Report"
          echo "================================"
          echo ""
          echo "üîç Validation: ${{ needs.validate-library.result }}"
          echo "üöÄ Publication: ${{ needs.publish-to-platformio.result }}"
          echo "üì¶ Version: ${{ needs.validate-library.outputs.version }}"
          echo ""
          
          if [ "${{ needs.publish-to-platformio.result }}" = "success" ]; then
            echo "‚úÖ SUCCESS: Library published to PlatformIO Registry"
            echo ""
            echo "üîó Next Steps:"
            echo "1. Verify at: https://registry.platformio.org/libraries"
            echo "2. Test installation in a new project"
            echo "3. Update documentation with installation instructions"
            echo "4. Announce on relevant channels"
            
          elif [ "${{ needs.validate-library.result }}" = "failure" ]; then
            echo "‚ùå FAILED: Library validation failed"
            echo ""
            echo "üîß Check the validation logs and fix any issues with:"
            echo "‚Ä¢ library.json format and required fields"
            echo "‚Ä¢ Version consistency across files"
            echo "‚Ä¢ Dependency availability"
            echo "‚Ä¢ Example file paths"
            
          elif [ "${{ needs.publish-to-platformio.result }}" = "failure" ]; then
            echo "‚ùå FAILED: Publication failed after successful validation"
            echo ""
            echo "üîß Possible solutions:"
            echo "‚Ä¢ Check PLATFORMIO_AUTH_TOKEN secret is valid"
            echo "‚Ä¢ Verify library name doesn't conflict"
            echo "‚Ä¢ Try manual publication using PlatformIO CLI"
            echo "‚Ä¢ Check PlatformIO Registry status"
            
          else
            echo "‚ö†Ô∏è  UNKNOWN: Unexpected workflow state"
          fi
          
          echo ""
          echo "üîó Resources:"
          echo "‚Ä¢ PlatformIO Documentation: https://docs.platformio.org/en/latest/librarymanager/"
          echo "‚Ä¢ Library Registry: https://registry.platformio.org/"
          echo "‚Ä¢ Publishing Guide: https://docs.platformio.org/en/latest/librarymanager/creating.html"
          echo "================================"